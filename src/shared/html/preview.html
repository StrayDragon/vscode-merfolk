<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'unsafe-inline' ${cspSource}; style-src 'unsafe-inline' ${cspSource};">
    <title>Mermaid Preview</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            padding: 20px;
            margin: 0;
        }
        #container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #mermaid-diagram {
            max-width: 100%;
            max-height: 100%;
            overflow: hidden;
            width: 100%;
            height: 100%;
            cursor: grab;
            position: relative;
        }
        #mermaid-diagram.grabbing {
            cursor: grabbing;
        }
        #mermaid-diagram svg {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
        }
        .empty {
            color: var(--vscode-descriptionForeground);
            font-style: italic;
            text-align: center;
            margin-top: 50px;
        }
        #error {
            color: var(--vscode-errorForeground);
            background-color: var(--vscode-inputValidation-errorBackground);
            border: 1px solid var(--vscode-inputValidation-errorBorder);
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: var(--vscode-font-family);
        }
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: var(--vscode-editor-background);
            border-bottom: 1px solid var(--vscode-panel-border);
        }
        .toolbar button {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-family: var(--vscode-font-family);
        }
        .toolbar button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        .mermaid-link {
            color: var(--vscode-textLink-foreground);
            text-decoration: underline;
            cursor: pointer;
        }
        .mermaid-link:hover {
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button onclick="zoomIn()">Zoom In</button>
        <button onclick="zoomOut()">Zoom Out</button>
        <button onclick="resetZoom()">Reset</button>
        <button onclick="fitToScreen()">Fit to Screen</button>
        <button onclick="exportSvg()">Export SVG</button>
        <button onclick="exportPng()">Export PNG</button>
    </div>
    <div id="container">
        <div id="mermaid-diagram"></div>
        <div id="error" style="display: none;"></div>
    </div>

    <!-- Using local Mermaid.js -->
    <script src="${mermaidUri}"></script>
    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            themeVariables: {
                primaryColor: '#bbdefb',
                primaryTextColor: '#000',
                primaryBorderColor: '#007bff',
                lineColor: '#666',
                secondaryColor: '#f8f9fa',
                tertiaryColor: '#e9ecef'
            },
            fontFamily: 'var(--vscode-font-family)',
            fontSize: 16,
            securityLevel: 'loose'
        });

        const vscode = acquireVsCodeApi();
        let currentContent = '';
        let currentZoom = 1;
        let currentPanX = 0;
        let currentPanY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;

        async function renderMermaid(content) {
            const element = document.getElementById('mermaid-diagram');
            const errorDiv = document.getElementById('error');

            // Clear previous content and errors
            if (element) element.innerHTML = '';
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }

            if (!content.trim()) {
                if (element) {
                    element.innerHTML = '<div class="empty">No Mermaid content to display.</div>';
                }
                return;
            }

            if (!element) {
                console.error('Mermaid container element not found');
                return;
            }

            try {
                // Parse the diagram first to catch syntax errors early
                await mermaid.parse(content);

                // Render the diagram
                const { svg } = await mermaid.render('mermaid-svg', content);
                element.innerHTML = svg;

                // Apply current zoom and pan
                applyTransform();

                // Setup drag handlers
                setupDragHandlers(element);

                // Process MermaidChart links after rendering
                processMermaidChartLinks();

            } catch (error) {
                const errorMessage = 'Syntax error: ' + (error.message || error);
                if (errorDiv) {
                    errorDiv.textContent = errorMessage;
                    errorDiv.style.display = 'block';
                }
                element.innerHTML = '';
                console.error('Mermaid rendering error:', error);
            }
        }

        function setupDragHandlers(element) {
            // Remove existing event listeners
            const newElement = element.cloneNode(true);
            element.parentNode.replaceChild(newElement, element);

            // Mouse events
            newElement.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);

            // Wheel events for zoom with mouse position
            newElement.addEventListener('wheel', handleWheel, { passive: false });
        }

        function handleMouseDown(e) {
            if (e.button !== 0) return; // Only left click
            isDragging = true;
            dragStartX = e.clientX - currentPanX;
            dragStartY = e.clientY - currentPanY;
            document.getElementById('mermaid-diagram').classList.add('grabbing');
            e.preventDefault();
        }

        function handleMouseMove(e) {
            if (!isDragging) return;
            currentPanX = e.clientX - dragStartX;
            currentPanY = e.clientY - dragStartY;
            applyTransform();
        }

        function handleMouseUp() {
            isDragging = false;
            document.getElementById('mermaid-diagram')?.classList.remove('grabbing');
        }

        function handleWheel(e) {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const newZoom = Math.max(0.3, Math.min(3, currentZoom * delta));

                // Zoom towards mouse position
                const scaleChange = newZoom - currentZoom;
                currentPanX -= (x - currentPanX) * (scaleChange / currentZoom);
                currentPanY -= (y - currentPanY) * (scaleChange / currentZoom);
                currentZoom = newZoom;

                applyTransform();
            }
        }

        function processMermaidChartLinks() {
            // Find all elements with MermaidChart links (look for href attributes starting with MermaidChart:)
            const links = document.querySelectorAll('[href*="MermaidChart:"]');

            links.forEach(link => {
                const href = link.getAttribute('href');
                if (href && href.startsWith('MermaidChart:')) {
                    // Extract the path after "MermaidChart:"
                    const path = href.substring('MermaidChart:'.length);

                    // Make it look clickable and styled
                    link.style.cursor = 'pointer';
                    link.className += ' mermaid-link';

                    // Remove the original href to prevent default navigation
                    link.removeAttribute('href');

                    // Add click handler
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        // Send message to extension to open the file
                        vscode.postMessage({
                            command: 'openMermaidChart',
                            path: path
                        });
                    });
                }
            });
        }

        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 3);
            applyTransform();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.2, 0.3);
            applyTransform();
        }

        function resetZoom() {
            currentZoom = 1;
            currentPanX = 0;
            currentPanY = 0;
            applyTransform();
        }

        function fitToScreen() {
            const container = document.getElementById('mermaid-diagram');
            const svg = container?.querySelector('svg');
            if (!svg || !container) return;

            const containerRect = container.getBoundingClientRect();
            const svgRect = svg.getBoundingClientRect();

            const scaleX = containerRect.width / svgRect.width;
            const scaleY = containerRect.height / svgRect.height;
            currentZoom = Math.min(scaleX, scaleY, 1) * 0.9; // 90% of container

            // Center the diagram
            currentPanX = (containerRect.width - svgRect.width * currentZoom) / 2;
            currentPanY = (containerRect.height - svgRect.height * currentZoom) / 2;

            applyTransform();
        }

        function applyTransform() {
            const svg = document.querySelector('#mermaid-diagram svg');
            if (svg) {
                svg.style.transform = `translate(${currentPanX}px, ${currentPanY}px) scale(${currentZoom})`;
                svg.style.width = `auto`;
                svg.style.height = `auto`;
            }
        }

        function exportSvg() {
            vscode.postMessage({ command: 'exportSvg' });
        }

        function exportPng() {
            vscode.postMessage({ command: 'exportPng' });
        }

        // Listen for messages from the extension
        window.addEventListener('message', async event => {
            const message = event.data;
            switch (message.command) {
                case 'updateContent':
                    currentContent = message.content;
                    await renderMermaid(currentContent);
                    break;
            }
        });

        // Initial render
        renderMermaid('').catch(console.error);
    </script>
</body>
</html>
